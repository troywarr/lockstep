!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.Lockstep=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(_dereq_,module,exports){
// shim for using process in browser

var process = module.exports = {};

process.nextTick = (function () {
    var canSetImmediate = typeof window !== 'undefined'
    && window.setImmediate;
    var canPost = typeof window !== 'undefined'
    && window.postMessage && window.addEventListener
    ;

    if (canSetImmediate) {
        return function (f) { return window.setImmediate(f) };
    }

    if (canPost) {
        var queue = [];
        window.addEventListener('message', function (ev) {
            var source = ev.source;
            if ((source === window || source === null) && ev.data === 'process-tick') {
                ev.stopPropagation();
                if (queue.length > 0) {
                    var fn = queue.shift();
                    fn();
                }
            }
        }, true);

        return function nextTick(fn) {
            queue.push(fn);
            window.postMessage('process-tick', '*');
        };
    }

    return function nextTick(fn) {
        setTimeout(fn, 0);
    };
})();

process.title = 'browser';
process.browser = true;
process.env = {};
process.argv = [];

function noop() {}

process.on = noop;
process.addListener = noop;
process.once = noop;
process.off = noop;
process.removeListener = noop;
process.removeAllListeners = noop;
process.emit = noop;

process.binding = function (name) {
    throw new Error('process.binding is not supported');
}

// TODO(shtylman)
process.cwd = function () { return '/' };
process.chdir = function (dir) {
    throw new Error('process.chdir is not supported');
};

},{}],2:[function(_dereq_,module,exports){
(function (process){
// Generated by CoffeeScript 1.7.1
(function() {
  var getNanoSeconds, hrtime, loadTime;

  if ((typeof performance !== "undefined" && performance !== null) && performance.now) {
    module.exports = function() {
      return performance.now();
    };
  } else if ((typeof process !== "undefined" && process !== null) && process.hrtime) {
    module.exports = function() {
      return (getNanoSeconds() - loadTime) / 1e6;
    };
    hrtime = process.hrtime;
    getNanoSeconds = function() {
      var hr;
      hr = hrtime();
      return hr[0] * 1e9 + hr[1];
    };
    loadTime = getNanoSeconds();
  } else if (Date.now) {
    module.exports = function() {
      return Date.now() - loadTime;
    };
    loadTime = Date.now();
  } else {
    module.exports = function() {
      return new Date().getTime() - loadTime;
    };
    loadTime = new Date().getTime();
  }

}).call(this);

}).call(this,_dereq_("1YiZ5S"))
},{"1YiZ5S":1}],3:[function(_dereq_,module,exports){
var now = _dereq_('performance-now')
  , global = typeof window === 'undefined' ? {} : window
  , vendors = ['moz', 'webkit']
  , suffix = 'AnimationFrame'
  , raf = global['request' + suffix]
  , caf = global['cancel' + suffix] || global['cancelRequest' + suffix]
  , isNative = true

for(var i = 0; i < vendors.length && !raf; i++) {
  raf = global[vendors[i] + 'Request' + suffix]
  caf = global[vendors[i] + 'Cancel' + suffix]
      || global[vendors[i] + 'CancelRequest' + suffix]
}

// Some versions of FF have rAF but not cAF
if(!raf || !caf) {
  isNative = false

  var last = 0
    , id = 0
    , queue = []
    , frameDuration = 1000 / 60

  raf = function(callback) {
    if(queue.length === 0) {
      var _now = now()
        , next = Math.max(0, frameDuration - (_now - last))
      last = next + _now
      setTimeout(function() {
        var cp = queue.slice(0)
        // Clear queue here to prevent
        // callbacks from appending listeners
        // to the current frame's queue
        queue.length = 0
        for(var i = 0; i < cp.length; i++) {
          if(!cp[i].cancelled) {
            try{
              cp[i].callback(last)
            } catch(e) {
              setTimeout(function() { throw e }, 0)
            }
          }
        }
      }, Math.round(next))
    }
    queue.push({
      handle: ++id,
      callback: callback,
      cancelled: false
    })
    return id
  }

  caf = function(handle) {
    for(var i = 0; i < queue.length; i++) {
      if(queue[i].handle === handle) {
        queue[i].cancelled = true
      }
    }
  }
}

module.exports = function(fn) {
  // Wrap in a new function to prevent
  // `cancel` potentially being assigned
  // to the native rAF function
  if(!isNative) {
    return raf.call(global, fn)
  }
  return raf.call(global, function() {
    try{
      fn.apply(this, arguments)
    } catch(e) {
      setTimeout(function() { throw e }, 0)
    }
  })
}
module.exports.cancel = function() {
  caf.apply(global, arguments)
}

},{"performance-now":4}],4:[function(_dereq_,module,exports){
(function (process){
// Generated by CoffeeScript 1.6.3
(function() {
  var getNanoSeconds, hrtime, loadTime;

  if ((typeof performance !== "undefined" && performance !== null) && performance.now) {
    module.exports = function() {
      return performance.now();
    };
  } else if ((typeof process !== "undefined" && process !== null) && process.hrtime) {
    module.exports = function() {
      return (getNanoSeconds() - loadTime) / 1e6;
    };
    hrtime = process.hrtime;
    getNanoSeconds = function() {
      var hr;
      hr = hrtime();
      return hr[0] * 1e9 + hr[1];
    };
    loadTime = getNanoSeconds();
  } else if (Date.now) {
    module.exports = function() {
      return Date.now() - loadTime;
    };
    loadTime = Date.now();
  } else {
    module.exports = function() {
      return new Date().getTime() - loadTime;
    };
    loadTime = new Date().getTime();
  }

}).call(this);

/*
//@ sourceMappingURL=performance-now.map
*/

}).call(this,_dereq_("1YiZ5S"))
},{"1YiZ5S":1}],5:[function(_dereq_,module,exports){
(function (process){
(function() {
  var Lockstep, MEASURES, MSQTY, NOOP, now, raf,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  raf = _dereq_('raf');

  now = _dereq_('performance-now');

  MSQTY = {};

  MSQTY.microseconds = 0.001;

  MSQTY.milliseconds = MSQTY.microseconds * 1000;

  MSQTY.seconds = MSQTY.milliseconds * 1000;

  MSQTY.minutes = MSQTY.seconds * 60;

  MSQTY.hours = MSQTY.minutes * 60;

  MSQTY.days = MSQTY.hours * 24;

  NOOP = function() {};

  MEASURES = ['microseconds', 'milliseconds', 'seconds', 'minutes', 'hours', 'days'];

  Lockstep = (function() {
    function Lockstep() {
      this._loop = __bind(this._loop, this);
      var options;
      options = this._validateOptions(arguments);
      this.settings = this._buildSettings(options);
      this.running = false;
      this.microseconds = this._hasHighResolutionTime();
      this.count = {
        start: 0,
        stop: 0,
        reset: 0
      };
      this.time = {
        start: null,
        stop: null,
        run: 0
      };
    }

    Lockstep.prototype._type = function(value) {
      return {}.toString.call(value).match(/\s([a-zA-Z]+)/)[1].toLowerCase();
    };

    Lockstep.prototype._isInt = function(value) {
      return !isNaN(value) && parseInt(Number(value)) === value && !isNaN(parseInt(value, 10));
    };

    Lockstep.prototype._merge = function(obj1, obj2) {
      var name, obj3;
      obj3 = {};
      for (name in obj1) {
        obj3[name] = obj1[name];
      }
      for (name in obj2) {
        obj3[name] = obj2[name];
      }
      return obj3;
    };

    Lockstep.prototype._pad = function(int, length) {
      int += '';
      if (int.length >= length) {
        return int;
      } else {
        return "" + (new Array(length - int.length + 1).join('0')) + int;
      }
    };

    Lockstep.prototype._hasHighResolutionTime = function() {
      var _ref;
      return ((typeof window !== "undefined" && window !== null ? (_ref = window.performance) != null ? _ref.now : void 0 : void 0) != null) || ((typeof process !== "undefined" && process !== null ? process.hrtime : void 0) != null);
    };

    Lockstep.prototype._validateOptions = function(args) {
      var options;
      if (args.length === 0) {
        throw new Error('No arguments supplied.');
      } else if (args.length === 1) {
        if (this._type(args[0]) === 'function') {
          options = {
            step: args[0]
          };
        } else if (this._type(args[0]) === 'object') {
          if (this._type(args[0].step) === 'function') {
            options = args[0];
          } else {
            throw new Error('Bad arguments supplied (no valid "step" function).');
          }
        } else {
          throw new Error('Bad arguments supplied (wrong type).');
        }
      } else if (args.length >= 2) {
        if (this._type(args[0]) === 'object' && this._type(args[1]) === 'function') {
          if (args[0].step != null) {
            throw new Error('Bad arguments supplied (redundant "step" function).');
          } else {
            args[0].step = args[1];
            options = args[0];
          }
        } else {
          throw new Error('Bad arguments supplied (wrong type).');
        }
      }
      if (options.pad != null) {
        if (!(options.pad === false || this._isInt(options.pad))) {
          throw new Error('Bad arguments supplied ("pad" option must have a false or integer value).');
        }
      }
      return options;
    };

    Lockstep.prototype._buildSettings = function(options) {
      var defaults;
      defaults = {
        pad: false,
        floor: false
      };
      return this._merge(defaults, options);
    };

    Lockstep.prototype._runTimeToClockTime = function(runTime) {
      var clockTime, milliseconds;
      clockTime = {};
      if (this.microseconds) {
        clockTime.microseconds = Math.floor((runTime % 1) / MSQTY.microseconds);
        milliseconds = Math.floor(runTime);
      } else {
        milliseconds = runTime;
      }
      clockTime.milliseconds = milliseconds % 1000;
      clockTime.seconds = Math.floor(milliseconds / MSQTY.seconds) % 60;
      clockTime.minutes = Math.floor(milliseconds / MSQTY.minutes) % 60;
      clockTime.hours = Math.floor(milliseconds / MSQTY.hours) % 24;
      clockTime.days = Math.floor(milliseconds / MSQTY.days);
      return clockTime;
    };

    Lockstep.prototype._runTimeToElapsedTime = function(runTime) {
      var elapsedTime, milliseconds;
      elapsedTime = {};
      if (this.microseconds) {
        elapsedTime.microseconds = runTime / MSQTY.microseconds;
        milliseconds = runTime;
      } else {
        milliseconds = runTime;
      }
      elapsedTime.milliseconds = milliseconds;
      elapsedTime.seconds = milliseconds / MSQTY.seconds;
      elapsedTime.minutes = milliseconds / MSQTY.minutes;
      elapsedTime.hours = milliseconds / MSQTY.hours;
      elapsedTime.days = milliseconds / MSQTY.days;
      return elapsedTime;
    };

    Lockstep.prototype._elapsedTimeToRunTime = function(elapsedTime) {
      var key, propQty, runTime, val;
      propQty = 0;
      runTime = 0;
      for (key in elapsedTime) {
        val = elapsedTime[key];
        if (++propQty > 1) {
          throw new Error('Bad arguments supplied (too many properties).');
        }
        if (__indexOf.call(MEASURES, key) >= 0) {
          runTime = MSQTY[key] * val;
        } else {
          throw new Error('Bad arguments supplied (wrong property).');
        }
      }
      return runTime;
    };

    Lockstep.prototype._clockTimeToRunTime = function(clockTime) {
      var key, runTime, val;
      runTime = 0;
      for (key in clockTime) {
        val = clockTime[key];
        if (__indexOf.call(MEASURES, key) >= 0) {
          runTime += MSQTY[key] * val;
        } else {
          throw new Error('Bad arguments supplied (wrong property).');
        }
      }
      return runTime;
    };

    Lockstep.prototype._getInfo = function() {
      var clock, elapsed, key, runTime, val;
      runTime = this.running ? this.time.run + now() - this.time.start : this.time.run;
      elapsed = this._runTimeToElapsedTime(runTime);
      clock = this._runTimeToClockTime(runTime);
      if (this.settings.floor) {
        for (key in elapsed) {
          val = elapsed[key];
          elapsed = Math.floor(val);
        }
      }
      if (this.settings.pad) {
        for (key in clock) {
          val = clock[key];
          val = this._pad(val, this.settings.pad);
        }
      }
      return {
        time: {
          elapsed: elapsed,
          clock: clock
        },
        count: this.count
      };
    };

    Lockstep.prototype._adjustRunTime = function(operation, runTime) {
      switch (operation) {
        case 'set':
          this.time.run = runTime;
          break;
        case 'add':
          this.time.run += runTime;
          break;
        case 'subtract':
          this.time.run -= runTime;
          break;
        default:
          throw new Error('Bad arguments supplied (invalid operation).');
      }
      if (!this.settings.allowNegative) {
        return this.time.run = Math.max(this.time.run, 0);
      }
    };

    Lockstep.prototype._adjustCount = function(operation, count) {
      var key, val;
      for (key in count) {
        val = count[key];
        if (key === 'start' || key === 'stop' || key === 'reset') {
          if (this._isInt(val)) {
            switch (operation) {
              case 'set':
                this.count[key] = val;
                break;
              case 'add':
                this.count[key] += val;
                break;
              case 'subtract':
                this.count[key] -= val;
                break;
              default:
                throw new Error('Bad arguments supplied (invalid operation).');
            }
            if (!this.settings.allowNegative) {
              this.count[key] = Math.max(this.count[key], 0);
            }
          } else {
            throw new Error('Bad arguments supplied (count value is not an integer).');
          }
        } else {
          throw new Error('Bad arguments supplied (wrong property).');
        }
      }
    };

    Lockstep.prototype._adjustInfo = function(operation, info) {
      if (this._type(info) === 'object') {
        if ((info.elapsed != null) && (info.clock != null)) {
          throw new Error('Bad arguments supplied (both elapsed and clock times).');
        }
        if (info.elapsed != null) {
          this._adjustRunTime(operation, this._elapsedTimeToRunTime(info.elapsed));
        }
        if (info.clock != null) {
          this._adjustRunTime(operation, this._clockTimeToRunTime(info.clock));
        }
        if (info.count != null) {
          return this._adjustCount(operation, info.count);
        }
      } else {
        throw new Error('Bad arguments supplied (wrong type).');
      }
    };

    Lockstep.prototype._loop = function() {
      this.pulse = raf(this._loop);
      return this._step();
    };

    Lockstep.prototype._step = function() {
      return this.settings.step(this._getInfo());
    };

    Lockstep.prototype.start = function(callback) {
      if (callback == null) {
        callback = this.settings.start;
      }
      if (!this.running) {
        this.count.start++;
        this.running = true;
        this.time.start = now();
        this._loop();
        if (typeof callback === "function") {
          callback(this._getInfo());
        }
      }
      return this;
    };

    Lockstep.prototype.stop = function(callback) {
      if (callback == null) {
        callback = this.settings.stop;
      }
      if (this.running) {
        raf.cancel(this.pulse);
        this.time.stop = now();
        this.time.run += this.time.stop - this.time.start;
        this.count.stop++;
        this.running = false;
        this._step();
        if (typeof callback === "function") {
          callback(this._getInfo());
        }
      }
      return this;
    };

    Lockstep.prototype.reset = function(callback, count) {
      var callbackEligible, key, val, _ref;
      if (callback == null) {
        callback = this.settings.reset;
      }
      if (this.time.run > 0) {
        callbackEligible = true;
        this.time.run = 0;
        this.count.reset++;
        this.time.start = now();
        this.time.stop = null;
      }
      if (count) {
        _ref = this.count;
        for (key in _ref) {
          val = _ref[key];
          if (val > 0) {
            callbackEligible = true;
            this.count.start = 0;
            this.count.stop = 0;
            this.count.reset = 0;
            break;
          }
        }
      }
      if ((callback != null) && callbackEligible) {
        if (this._type(callback) === 'function') {
          if (typeof callback === "function") {
            callback(this._getInfo());
          }
        } else {
          throw new Error('Bad arguments supplied (wrong type).');
        }
      }
      return this;
    };

    Lockstep.prototype.info = function(info, callback) {
      if (callback == null) {
        callback = this.settings.info;
      }
      if (info != null) {
        this._adjustInfo('set', info);
        if (typeof callback === "function") {
          callback(this._getInfo());
        }
        return this;
      } else {
        return this._getInfo();
      }
    };

    Lockstep.prototype.add = function(info, callback) {
      if (callback == null) {
        callback = this.settings.add;
      }
      if (info != null) {
        this._adjustInfo('add', info);
        if (typeof callback === "function") {
          callback(this._getInfo());
        }
        return this;
      } else {
        throw new Error('No arguments supplied.');
      }
    };

    Lockstep.prototype.subtract = function(info, callback) {
      if (callback == null) {
        callback = this.settings.subtract;
      }
      if (info != null) {
        this._adjustInfo('subtract', info);
        if (typeof callback === "function") {
          callback(this._getInfo());
        }
        return this;
      } else {
        throw new Error('No arguments supplied.');
      }
    };

    return Lockstep;

  })();

  module.exports = Lockstep;

}).call(this);

}).call(this,_dereq_("1YiZ5S"))
},{"1YiZ5S":1,"performance-now":2,"raf":3}]},{},[5])
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy90d2Fyci9jb2RlL2xvY2tzdGVwL25vZGVfbW9kdWxlcy9ndWxwLWJyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsIi9Vc2Vycy90d2Fyci9jb2RlL2xvY2tzdGVwL25vZGVfbW9kdWxlcy9ndWxwLWJyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL3Byb2Nlc3MvYnJvd3Nlci5qcyIsIi9Vc2Vycy90d2Fyci9jb2RlL2xvY2tzdGVwL25vZGVfbW9kdWxlcy9wZXJmb3JtYW5jZS1ub3cvbGliL3BlcmZvcm1hbmNlLW5vdy5qcyIsIi9Vc2Vycy90d2Fyci9jb2RlL2xvY2tzdGVwL25vZGVfbW9kdWxlcy9yYWYvaW5kZXguanMiLCIvVXNlcnMvdHdhcnIvY29kZS9sb2Nrc3RlcC9ub2RlX21vZHVsZXMvcmFmL25vZGVfbW9kdWxlcy9wZXJmb3JtYW5jZS1ub3cvbGliL3BlcmZvcm1hbmNlLW5vdy5qcyIsIi9Vc2Vycy90d2Fyci9jb2RlL2xvY2tzdGVwL3NyYy9mYWtlXzM4YTM1NGQzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDL0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDbENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNoRkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3RDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpfXZhciBmPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChmLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGYsZi5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIvLyBzaGltIGZvciB1c2luZyBwcm9jZXNzIGluIGJyb3dzZXJcblxudmFyIHByb2Nlc3MgPSBtb2R1bGUuZXhwb3J0cyA9IHt9O1xuXG5wcm9jZXNzLm5leHRUaWNrID0gKGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgY2FuU2V0SW1tZWRpYXRlID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCdcbiAgICAmJiB3aW5kb3cuc2V0SW1tZWRpYXRlO1xuICAgIHZhciBjYW5Qb3N0ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCdcbiAgICAmJiB3aW5kb3cucG9zdE1lc3NhZ2UgJiYgd2luZG93LmFkZEV2ZW50TGlzdGVuZXJcbiAgICA7XG5cbiAgICBpZiAoY2FuU2V0SW1tZWRpYXRlKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoZikgeyByZXR1cm4gd2luZG93LnNldEltbWVkaWF0ZShmKSB9O1xuICAgIH1cblxuICAgIGlmIChjYW5Qb3N0KSB7XG4gICAgICAgIHZhciBxdWV1ZSA9IFtdO1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uIChldikge1xuICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGV2LnNvdXJjZTtcbiAgICAgICAgICAgIGlmICgoc291cmNlID09PSB3aW5kb3cgfHwgc291cmNlID09PSBudWxsKSAmJiBldi5kYXRhID09PSAncHJvY2Vzcy10aWNrJykge1xuICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBmbiA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgICAgICAgICAgICAgICAgIGZuKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCB0cnVlKTtcblxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmV4dFRpY2soZm4pIHtcbiAgICAgICAgICAgIHF1ZXVlLnB1c2goZm4pO1xuICAgICAgICAgICAgd2luZG93LnBvc3RNZXNzYWdlKCdwcm9jZXNzLXRpY2snLCAnKicpO1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBmdW5jdGlvbiBuZXh0VGljayhmbikge1xuICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTtcbiAgICB9O1xufSkoKTtcblxucHJvY2Vzcy50aXRsZSA9ICdicm93c2VyJztcbnByb2Nlc3MuYnJvd3NlciA9IHRydWU7XG5wcm9jZXNzLmVudiA9IHt9O1xucHJvY2Vzcy5hcmd2ID0gW107XG5cbmZ1bmN0aW9uIG5vb3AoKSB7fVxuXG5wcm9jZXNzLm9uID0gbm9vcDtcbnByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wO1xucHJvY2Vzcy5vbmNlID0gbm9vcDtcbnByb2Nlc3Mub2ZmID0gbm9vcDtcbnByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wO1xucHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBub29wO1xucHJvY2Vzcy5lbWl0ID0gbm9vcDtcblxucHJvY2Vzcy5iaW5kaW5nID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkJyk7XG59XG5cbi8vIFRPRE8oc2h0eWxtYW4pXG5wcm9jZXNzLmN3ZCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICcvJyB9O1xucHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuY2hkaXIgaXMgbm90IHN1cHBvcnRlZCcpO1xufTtcbiIsIihmdW5jdGlvbiAocHJvY2Vzcyl7XG4vLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuNy4xXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBnZXROYW5vU2Vjb25kcywgaHJ0aW1lLCBsb2FkVGltZTtcblxuICBpZiAoKHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gXCJ1bmRlZmluZWRcIiAmJiBwZXJmb3JtYW5jZSAhPT0gbnVsbCkgJiYgcGVyZm9ybWFuY2Uubm93KSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICB9O1xuICB9IGVsc2UgaWYgKCh0eXBlb2YgcHJvY2VzcyAhPT0gXCJ1bmRlZmluZWRcIiAmJiBwcm9jZXNzICE9PSBudWxsKSAmJiBwcm9jZXNzLmhydGltZSkge1xuICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gKGdldE5hbm9TZWNvbmRzKCkgLSBsb2FkVGltZSkgLyAxZTY7XG4gICAgfTtcbiAgICBocnRpbWUgPSBwcm9jZXNzLmhydGltZTtcbiAgICBnZXROYW5vU2Vjb25kcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGhyO1xuICAgICAgaHIgPSBocnRpbWUoKTtcbiAgICAgIHJldHVybiBoclswXSAqIDFlOSArIGhyWzFdO1xuICAgIH07XG4gICAgbG9hZFRpbWUgPSBnZXROYW5vU2Vjb25kcygpO1xuICB9IGVsc2UgaWYgKERhdGUubm93KSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBEYXRlLm5vdygpIC0gbG9hZFRpbWU7XG4gICAgfTtcbiAgICBsb2FkVGltZSA9IERhdGUubm93KCk7XG4gIH0gZWxzZSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIGxvYWRUaW1lO1xuICAgIH07XG4gICAgbG9hZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgfVxuXG59KS5jYWxsKHRoaXMpO1xuXG59KS5jYWxsKHRoaXMscmVxdWlyZShcIjFZaVo1U1wiKSkiLCJ2YXIgbm93ID0gcmVxdWlyZSgncGVyZm9ybWFuY2Utbm93JylcbiAgLCBnbG9iYWwgPSB0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyA/IHt9IDogd2luZG93XG4gICwgdmVuZG9ycyA9IFsnbW96JywgJ3dlYmtpdCddXG4gICwgc3VmZml4ID0gJ0FuaW1hdGlvbkZyYW1lJ1xuICAsIHJhZiA9IGdsb2JhbFsncmVxdWVzdCcgKyBzdWZmaXhdXG4gICwgY2FmID0gZ2xvYmFsWydjYW5jZWwnICsgc3VmZml4XSB8fCBnbG9iYWxbJ2NhbmNlbFJlcXVlc3QnICsgc3VmZml4XVxuICAsIGlzTmF0aXZlID0gdHJ1ZVxuXG5mb3IodmFyIGkgPSAwOyBpIDwgdmVuZG9ycy5sZW5ndGggJiYgIXJhZjsgaSsrKSB7XG4gIHJhZiA9IGdsb2JhbFt2ZW5kb3JzW2ldICsgJ1JlcXVlc3QnICsgc3VmZml4XVxuICBjYWYgPSBnbG9iYWxbdmVuZG9yc1tpXSArICdDYW5jZWwnICsgc3VmZml4XVxuICAgICAgfHwgZ2xvYmFsW3ZlbmRvcnNbaV0gKyAnQ2FuY2VsUmVxdWVzdCcgKyBzdWZmaXhdXG59XG5cbi8vIFNvbWUgdmVyc2lvbnMgb2YgRkYgaGF2ZSByQUYgYnV0IG5vdCBjQUZcbmlmKCFyYWYgfHwgIWNhZikge1xuICBpc05hdGl2ZSA9IGZhbHNlXG5cbiAgdmFyIGxhc3QgPSAwXG4gICAgLCBpZCA9IDBcbiAgICAsIHF1ZXVlID0gW11cbiAgICAsIGZyYW1lRHVyYXRpb24gPSAxMDAwIC8gNjBcblxuICByYWYgPSBmdW5jdGlvbihjYWxsYmFjaykge1xuICAgIGlmKHF1ZXVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdmFyIF9ub3cgPSBub3coKVxuICAgICAgICAsIG5leHQgPSBNYXRoLm1heCgwLCBmcmFtZUR1cmF0aW9uIC0gKF9ub3cgLSBsYXN0KSlcbiAgICAgIGxhc3QgPSBuZXh0ICsgX25vd1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIGNwID0gcXVldWUuc2xpY2UoMClcbiAgICAgICAgLy8gQ2xlYXIgcXVldWUgaGVyZSB0byBwcmV2ZW50XG4gICAgICAgIC8vIGNhbGxiYWNrcyBmcm9tIGFwcGVuZGluZyBsaXN0ZW5lcnNcbiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnQgZnJhbWUncyBxdWV1ZVxuICAgICAgICBxdWV1ZS5sZW5ndGggPSAwXG4gICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBjcC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGlmKCFjcFtpXS5jYW5jZWxsZWQpIHtcbiAgICAgICAgICAgIHRyeXtcbiAgICAgICAgICAgICAgY3BbaV0uY2FsbGJhY2sobGFzdClcbiAgICAgICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyB0aHJvdyBlIH0sIDApXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LCBNYXRoLnJvdW5kKG5leHQpKVxuICAgIH1cbiAgICBxdWV1ZS5wdXNoKHtcbiAgICAgIGhhbmRsZTogKytpZCxcbiAgICAgIGNhbGxiYWNrOiBjYWxsYmFjayxcbiAgICAgIGNhbmNlbGxlZDogZmFsc2VcbiAgICB9KVxuICAgIHJldHVybiBpZFxuICB9XG5cbiAgY2FmID0gZnVuY3Rpb24oaGFuZGxlKSB7XG4gICAgZm9yKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZihxdWV1ZVtpXS5oYW5kbGUgPT09IGhhbmRsZSkge1xuICAgICAgICBxdWV1ZVtpXS5jYW5jZWxsZWQgPSB0cnVlXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oZm4pIHtcbiAgLy8gV3JhcCBpbiBhIG5ldyBmdW5jdGlvbiB0byBwcmV2ZW50XG4gIC8vIGBjYW5jZWxgIHBvdGVudGlhbGx5IGJlaW5nIGFzc2lnbmVkXG4gIC8vIHRvIHRoZSBuYXRpdmUgckFGIGZ1bmN0aW9uXG4gIGlmKCFpc05hdGl2ZSkge1xuICAgIHJldHVybiByYWYuY2FsbChnbG9iYWwsIGZuKVxuICB9XG4gIHJldHVybiByYWYuY2FsbChnbG9iYWwsIGZ1bmN0aW9uKCkge1xuICAgIHRyeXtcbiAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cylcbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHRocm93IGUgfSwgMClcbiAgICB9XG4gIH0pXG59XG5tb2R1bGUuZXhwb3J0cy5jYW5jZWwgPSBmdW5jdGlvbigpIHtcbiAgY2FmLmFwcGx5KGdsb2JhbCwgYXJndW1lbnRzKVxufVxuIiwiKGZ1bmN0aW9uIChwcm9jZXNzKXtcbi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS42LjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIGdldE5hbm9TZWNvbmRzLCBocnRpbWUsIGxvYWRUaW1lO1xuXG4gIGlmICgodHlwZW9mIHBlcmZvcm1hbmNlICE9PSBcInVuZGVmaW5lZFwiICYmIHBlcmZvcm1hbmNlICE9PSBudWxsKSAmJiBwZXJmb3JtYW5jZS5ub3cpIHtcbiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIH07XG4gIH0gZWxzZSBpZiAoKHR5cGVvZiBwcm9jZXNzICE9PSBcInVuZGVmaW5lZFwiICYmIHByb2Nlc3MgIT09IG51bGwpICYmIHByb2Nlc3MuaHJ0aW1lKSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiAoZ2V0TmFub1NlY29uZHMoKSAtIGxvYWRUaW1lKSAvIDFlNjtcbiAgICB9O1xuICAgIGhydGltZSA9IHByb2Nlc3MuaHJ0aW1lO1xuICAgIGdldE5hbm9TZWNvbmRzID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgaHI7XG4gICAgICBociA9IGhydGltZSgpO1xuICAgICAgcmV0dXJuIGhyWzBdICogMWU5ICsgaHJbMV07XG4gICAgfTtcbiAgICBsb2FkVGltZSA9IGdldE5hbm9TZWNvbmRzKCk7XG4gIH0gZWxzZSBpZiAoRGF0ZS5ub3cpIHtcbiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIERhdGUubm93KCkgLSBsb2FkVGltZTtcbiAgICB9O1xuICAgIGxvYWRUaW1lID0gRGF0ZS5ub3coKTtcbiAgfSBlbHNlIHtcbiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbG9hZFRpbWU7XG4gICAgfTtcbiAgICBsb2FkVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICB9XG5cbn0pLmNhbGwodGhpcyk7XG5cbi8qXG4vL0Agc291cmNlTWFwcGluZ1VSTD1wZXJmb3JtYW5jZS1ub3cubWFwXG4qL1xuXG59KS5jYWxsKHRoaXMscmVxdWlyZShcIjFZaVo1U1wiKSkiLCIoZnVuY3Rpb24gKHByb2Nlc3Mpe1xuKGZ1bmN0aW9uKCkge1xuICB2YXIgTG9ja3N0ZXAsIE1FQVNVUkVTLCBNU1FUWSwgTk9PUCwgbm93LCByYWYsXG4gICAgX19iaW5kID0gZnVuY3Rpb24oZm4sIG1lKXsgcmV0dXJuIGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShtZSwgYXJndW1lbnRzKTsgfTsgfSxcbiAgICBfX2luZGV4T2YgPSBbXS5pbmRleE9mIHx8IGZ1bmN0aW9uKGl0ZW0pIHsgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgeyBpZiAoaSBpbiB0aGlzICYmIHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOyB9IHJldHVybiAtMTsgfTtcblxuICByYWYgPSByZXF1aXJlKCdyYWYnKTtcblxuICBub3cgPSByZXF1aXJlKCdwZXJmb3JtYW5jZS1ub3cnKTtcblxuICBNU1FUWSA9IHt9O1xuXG4gIE1TUVRZLm1pY3Jvc2Vjb25kcyA9IDAuMDAxO1xuXG4gIE1TUVRZLm1pbGxpc2Vjb25kcyA9IE1TUVRZLm1pY3Jvc2Vjb25kcyAqIDEwMDA7XG5cbiAgTVNRVFkuc2Vjb25kcyA9IE1TUVRZLm1pbGxpc2Vjb25kcyAqIDEwMDA7XG5cbiAgTVNRVFkubWludXRlcyA9IE1TUVRZLnNlY29uZHMgKiA2MDtcblxuICBNU1FUWS5ob3VycyA9IE1TUVRZLm1pbnV0ZXMgKiA2MDtcblxuICBNU1FUWS5kYXlzID0gTVNRVFkuaG91cnMgKiAyNDtcblxuICBOT09QID0gZnVuY3Rpb24oKSB7fTtcblxuICBNRUFTVVJFUyA9IFsnbWljcm9zZWNvbmRzJywgJ21pbGxpc2Vjb25kcycsICdzZWNvbmRzJywgJ21pbnV0ZXMnLCAnaG91cnMnLCAnZGF5cyddO1xuXG4gIExvY2tzdGVwID0gKGZ1bmN0aW9uKCkge1xuICAgIGZ1bmN0aW9uIExvY2tzdGVwKCkge1xuICAgICAgdGhpcy5fbG9vcCA9IF9fYmluZCh0aGlzLl9sb29wLCB0aGlzKTtcbiAgICAgIHZhciBvcHRpb25zO1xuICAgICAgb3B0aW9ucyA9IHRoaXMuX3ZhbGlkYXRlT3B0aW9ucyhhcmd1bWVudHMpO1xuICAgICAgdGhpcy5zZXR0aW5ncyA9IHRoaXMuX2J1aWxkU2V0dGluZ3Mob3B0aW9ucyk7XG4gICAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMubWljcm9zZWNvbmRzID0gdGhpcy5faGFzSGlnaFJlc29sdXRpb25UaW1lKCk7XG4gICAgICB0aGlzLmNvdW50ID0ge1xuICAgICAgICBzdGFydDogMCxcbiAgICAgICAgc3RvcDogMCxcbiAgICAgICAgcmVzZXQ6IDBcbiAgICAgIH07XG4gICAgICB0aGlzLnRpbWUgPSB7XG4gICAgICAgIHN0YXJ0OiBudWxsLFxuICAgICAgICBzdG9wOiBudWxsLFxuICAgICAgICBydW46IDBcbiAgICAgIH07XG4gICAgfVxuXG4gICAgTG9ja3N0ZXAucHJvdG90eXBlLl90eXBlID0gZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHJldHVybiB7fS50b1N0cmluZy5jYWxsKHZhbHVlKS5tYXRjaCgvXFxzKFthLXpBLVpdKykvKVsxXS50b0xvd2VyQ2FzZSgpO1xuICAgIH07XG5cbiAgICBMb2Nrc3RlcC5wcm90b3R5cGUuX2lzSW50ID0gZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHJldHVybiAhaXNOYU4odmFsdWUpICYmIHBhcnNlSW50KE51bWJlcih2YWx1ZSkpID09PSB2YWx1ZSAmJiAhaXNOYU4ocGFyc2VJbnQodmFsdWUsIDEwKSk7XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5fbWVyZ2UgPSBmdW5jdGlvbihvYmoxLCBvYmoyKSB7XG4gICAgICB2YXIgbmFtZSwgb2JqMztcbiAgICAgIG9iajMgPSB7fTtcbiAgICAgIGZvciAobmFtZSBpbiBvYmoxKSB7XG4gICAgICAgIG9iajNbbmFtZV0gPSBvYmoxW25hbWVdO1xuICAgICAgfVxuICAgICAgZm9yIChuYW1lIGluIG9iajIpIHtcbiAgICAgICAgb2JqM1tuYW1lXSA9IG9iajJbbmFtZV07XG4gICAgICB9XG4gICAgICByZXR1cm4gb2JqMztcbiAgICB9O1xuXG4gICAgTG9ja3N0ZXAucHJvdG90eXBlLl9wYWQgPSBmdW5jdGlvbihpbnQsIGxlbmd0aCkge1xuICAgICAgaW50ICs9ICcnO1xuICAgICAgaWYgKGludC5sZW5ndGggPj0gbGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBpbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gXCJcIiArIChuZXcgQXJyYXkobGVuZ3RoIC0gaW50Lmxlbmd0aCArIDEpLmpvaW4oJzAnKSkgKyBpbnQ7XG4gICAgICB9XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5faGFzSGlnaFJlc29sdXRpb25UaW1lID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgX3JlZjtcbiAgICAgIHJldHVybiAoKHR5cGVvZiB3aW5kb3cgIT09IFwidW5kZWZpbmVkXCIgJiYgd2luZG93ICE9PSBudWxsID8gKF9yZWYgPSB3aW5kb3cucGVyZm9ybWFuY2UpICE9IG51bGwgPyBfcmVmLm5vdyA6IHZvaWQgMCA6IHZvaWQgMCkgIT0gbnVsbCkgfHwgKCh0eXBlb2YgcHJvY2VzcyAhPT0gXCJ1bmRlZmluZWRcIiAmJiBwcm9jZXNzICE9PSBudWxsID8gcHJvY2Vzcy5ocnRpbWUgOiB2b2lkIDApICE9IG51bGwpO1xuICAgIH07XG5cbiAgICBMb2Nrc3RlcC5wcm90b3R5cGUuX3ZhbGlkYXRlT3B0aW9ucyA9IGZ1bmN0aW9uKGFyZ3MpIHtcbiAgICAgIHZhciBvcHRpb25zO1xuICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gYXJndW1lbnRzIHN1cHBsaWVkLicpO1xuICAgICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICBpZiAodGhpcy5fdHlwZShhcmdzWzBdKSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICBzdGVwOiBhcmdzWzBdXG4gICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl90eXBlKGFyZ3NbMF0pID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgIGlmICh0aGlzLl90eXBlKGFyZ3NbMF0uc3RlcCkgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSBhcmdzWzBdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCBhcmd1bWVudHMgc3VwcGxpZWQgKG5vIHZhbGlkIFwic3RlcFwiIGZ1bmN0aW9uKS4nKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgYXJndW1lbnRzIHN1cHBsaWVkICh3cm9uZyB0eXBlKS4nKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCA+PSAyKSB7XG4gICAgICAgIGlmICh0aGlzLl90eXBlKGFyZ3NbMF0pID09PSAnb2JqZWN0JyAmJiB0aGlzLl90eXBlKGFyZ3NbMV0pID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgaWYgKGFyZ3NbMF0uc3RlcCAhPSBudWxsKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCBhcmd1bWVudHMgc3VwcGxpZWQgKHJlZHVuZGFudCBcInN0ZXBcIiBmdW5jdGlvbikuJyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFyZ3NbMF0uc3RlcCA9IGFyZ3NbMV07XG4gICAgICAgICAgICBvcHRpb25zID0gYXJnc1swXTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgYXJndW1lbnRzIHN1cHBsaWVkICh3cm9uZyB0eXBlKS4nKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKG9wdGlvbnMucGFkICE9IG51bGwpIHtcbiAgICAgICAgaWYgKCEob3B0aW9ucy5wYWQgPT09IGZhbHNlIHx8IHRoaXMuX2lzSW50KG9wdGlvbnMucGFkKSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCBhcmd1bWVudHMgc3VwcGxpZWQgKFwicGFkXCIgb3B0aW9uIG11c3QgaGF2ZSBhIGZhbHNlIG9yIGludGVnZXIgdmFsdWUpLicpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gb3B0aW9ucztcbiAgICB9O1xuXG4gICAgTG9ja3N0ZXAucHJvdG90eXBlLl9idWlsZFNldHRpbmdzID0gZnVuY3Rpb24ob3B0aW9ucykge1xuICAgICAgdmFyIGRlZmF1bHRzO1xuICAgICAgZGVmYXVsdHMgPSB7XG4gICAgICAgIHBhZDogZmFsc2UsXG4gICAgICAgIGZsb29yOiBmYWxzZVxuICAgICAgfTtcbiAgICAgIHJldHVybiB0aGlzLl9tZXJnZShkZWZhdWx0cywgb3B0aW9ucyk7XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5fcnVuVGltZVRvQ2xvY2tUaW1lID0gZnVuY3Rpb24ocnVuVGltZSkge1xuICAgICAgdmFyIGNsb2NrVGltZSwgbWlsbGlzZWNvbmRzO1xuICAgICAgY2xvY2tUaW1lID0ge307XG4gICAgICBpZiAodGhpcy5taWNyb3NlY29uZHMpIHtcbiAgICAgICAgY2xvY2tUaW1lLm1pY3Jvc2Vjb25kcyA9IE1hdGguZmxvb3IoKHJ1blRpbWUgJSAxKSAvIE1TUVRZLm1pY3Jvc2Vjb25kcyk7XG4gICAgICAgIG1pbGxpc2Vjb25kcyA9IE1hdGguZmxvb3IocnVuVGltZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtaWxsaXNlY29uZHMgPSBydW5UaW1lO1xuICAgICAgfVxuICAgICAgY2xvY2tUaW1lLm1pbGxpc2Vjb25kcyA9IG1pbGxpc2Vjb25kcyAlIDEwMDA7XG4gICAgICBjbG9ja1RpbWUuc2Vjb25kcyA9IE1hdGguZmxvb3IobWlsbGlzZWNvbmRzIC8gTVNRVFkuc2Vjb25kcykgJSA2MDtcbiAgICAgIGNsb2NrVGltZS5taW51dGVzID0gTWF0aC5mbG9vcihtaWxsaXNlY29uZHMgLyBNU1FUWS5taW51dGVzKSAlIDYwO1xuICAgICAgY2xvY2tUaW1lLmhvdXJzID0gTWF0aC5mbG9vcihtaWxsaXNlY29uZHMgLyBNU1FUWS5ob3VycykgJSAyNDtcbiAgICAgIGNsb2NrVGltZS5kYXlzID0gTWF0aC5mbG9vcihtaWxsaXNlY29uZHMgLyBNU1FUWS5kYXlzKTtcbiAgICAgIHJldHVybiBjbG9ja1RpbWU7XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5fcnVuVGltZVRvRWxhcHNlZFRpbWUgPSBmdW5jdGlvbihydW5UaW1lKSB7XG4gICAgICB2YXIgZWxhcHNlZFRpbWUsIG1pbGxpc2Vjb25kcztcbiAgICAgIGVsYXBzZWRUaW1lID0ge307XG4gICAgICBpZiAodGhpcy5taWNyb3NlY29uZHMpIHtcbiAgICAgICAgZWxhcHNlZFRpbWUubWljcm9zZWNvbmRzID0gcnVuVGltZSAvIE1TUVRZLm1pY3Jvc2Vjb25kcztcbiAgICAgICAgbWlsbGlzZWNvbmRzID0gcnVuVGltZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1pbGxpc2Vjb25kcyA9IHJ1blRpbWU7XG4gICAgICB9XG4gICAgICBlbGFwc2VkVGltZS5taWxsaXNlY29uZHMgPSBtaWxsaXNlY29uZHM7XG4gICAgICBlbGFwc2VkVGltZS5zZWNvbmRzID0gbWlsbGlzZWNvbmRzIC8gTVNRVFkuc2Vjb25kcztcbiAgICAgIGVsYXBzZWRUaW1lLm1pbnV0ZXMgPSBtaWxsaXNlY29uZHMgLyBNU1FUWS5taW51dGVzO1xuICAgICAgZWxhcHNlZFRpbWUuaG91cnMgPSBtaWxsaXNlY29uZHMgLyBNU1FUWS5ob3VycztcbiAgICAgIGVsYXBzZWRUaW1lLmRheXMgPSBtaWxsaXNlY29uZHMgLyBNU1FUWS5kYXlzO1xuICAgICAgcmV0dXJuIGVsYXBzZWRUaW1lO1xuICAgIH07XG5cbiAgICBMb2Nrc3RlcC5wcm90b3R5cGUuX2VsYXBzZWRUaW1lVG9SdW5UaW1lID0gZnVuY3Rpb24oZWxhcHNlZFRpbWUpIHtcbiAgICAgIHZhciBrZXksIHByb3BRdHksIHJ1blRpbWUsIHZhbDtcbiAgICAgIHByb3BRdHkgPSAwO1xuICAgICAgcnVuVGltZSA9IDA7XG4gICAgICBmb3IgKGtleSBpbiBlbGFwc2VkVGltZSkge1xuICAgICAgICB2YWwgPSBlbGFwc2VkVGltZVtrZXldO1xuICAgICAgICBpZiAoKytwcm9wUXR5ID4gMSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIGFyZ3VtZW50cyBzdXBwbGllZCAodG9vIG1hbnkgcHJvcGVydGllcykuJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF9faW5kZXhPZi5jYWxsKE1FQVNVUkVTLCBrZXkpID49IDApIHtcbiAgICAgICAgICBydW5UaW1lID0gTVNRVFlba2V5XSAqIHZhbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCBhcmd1bWVudHMgc3VwcGxpZWQgKHdyb25nIHByb3BlcnR5KS4nKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJ1blRpbWU7XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5fY2xvY2tUaW1lVG9SdW5UaW1lID0gZnVuY3Rpb24oY2xvY2tUaW1lKSB7XG4gICAgICB2YXIga2V5LCBydW5UaW1lLCB2YWw7XG4gICAgICBydW5UaW1lID0gMDtcbiAgICAgIGZvciAoa2V5IGluIGNsb2NrVGltZSkge1xuICAgICAgICB2YWwgPSBjbG9ja1RpbWVba2V5XTtcbiAgICAgICAgaWYgKF9faW5kZXhPZi5jYWxsKE1FQVNVUkVTLCBrZXkpID49IDApIHtcbiAgICAgICAgICBydW5UaW1lICs9IE1TUVRZW2tleV0gKiB2YWw7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgYXJndW1lbnRzIHN1cHBsaWVkICh3cm9uZyBwcm9wZXJ0eSkuJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBydW5UaW1lO1xuICAgIH07XG5cbiAgICBMb2Nrc3RlcC5wcm90b3R5cGUuX2dldEluZm8gPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBjbG9jaywgZWxhcHNlZCwga2V5LCBydW5UaW1lLCB2YWw7XG4gICAgICBydW5UaW1lID0gdGhpcy5ydW5uaW5nID8gdGhpcy50aW1lLnJ1biArIG5vdygpIC0gdGhpcy50aW1lLnN0YXJ0IDogdGhpcy50aW1lLnJ1bjtcbiAgICAgIGVsYXBzZWQgPSB0aGlzLl9ydW5UaW1lVG9FbGFwc2VkVGltZShydW5UaW1lKTtcbiAgICAgIGNsb2NrID0gdGhpcy5fcnVuVGltZVRvQ2xvY2tUaW1lKHJ1blRpbWUpO1xuICAgICAgaWYgKHRoaXMuc2V0dGluZ3MuZmxvb3IpIHtcbiAgICAgICAgZm9yIChrZXkgaW4gZWxhcHNlZCkge1xuICAgICAgICAgIHZhbCA9IGVsYXBzZWRba2V5XTtcbiAgICAgICAgICBlbGFwc2VkID0gTWF0aC5mbG9vcih2YWwpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5zZXR0aW5ncy5wYWQpIHtcbiAgICAgICAgZm9yIChrZXkgaW4gY2xvY2spIHtcbiAgICAgICAgICB2YWwgPSBjbG9ja1trZXldO1xuICAgICAgICAgIHZhbCA9IHRoaXMuX3BhZCh2YWwsIHRoaXMuc2V0dGluZ3MucGFkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdGltZToge1xuICAgICAgICAgIGVsYXBzZWQ6IGVsYXBzZWQsXG4gICAgICAgICAgY2xvY2s6IGNsb2NrXG4gICAgICAgIH0sXG4gICAgICAgIGNvdW50OiB0aGlzLmNvdW50XG4gICAgICB9O1xuICAgIH07XG5cbiAgICBMb2Nrc3RlcC5wcm90b3R5cGUuX2FkanVzdFJ1blRpbWUgPSBmdW5jdGlvbihvcGVyYXRpb24sIHJ1blRpbWUpIHtcbiAgICAgIHN3aXRjaCAob3BlcmF0aW9uKSB7XG4gICAgICAgIGNhc2UgJ3NldCc6XG4gICAgICAgICAgdGhpcy50aW1lLnJ1biA9IHJ1blRpbWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2FkZCc6XG4gICAgICAgICAgdGhpcy50aW1lLnJ1biArPSBydW5UaW1lO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdzdWJ0cmFjdCc6XG4gICAgICAgICAgdGhpcy50aW1lLnJ1biAtPSBydW5UaW1lO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIGFyZ3VtZW50cyBzdXBwbGllZCAoaW52YWxpZCBvcGVyYXRpb24pLicpO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLnNldHRpbmdzLmFsbG93TmVnYXRpdmUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGltZS5ydW4gPSBNYXRoLm1heCh0aGlzLnRpbWUucnVuLCAwKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgTG9ja3N0ZXAucHJvdG90eXBlLl9hZGp1c3RDb3VudCA9IGZ1bmN0aW9uKG9wZXJhdGlvbiwgY291bnQpIHtcbiAgICAgIHZhciBrZXksIHZhbDtcbiAgICAgIGZvciAoa2V5IGluIGNvdW50KSB7XG4gICAgICAgIHZhbCA9IGNvdW50W2tleV07XG4gICAgICAgIGlmIChrZXkgPT09ICdzdGFydCcgfHwga2V5ID09PSAnc3RvcCcgfHwga2V5ID09PSAncmVzZXQnKSB7XG4gICAgICAgICAgaWYgKHRoaXMuX2lzSW50KHZhbCkpIHtcbiAgICAgICAgICAgIHN3aXRjaCAob3BlcmF0aW9uKSB7XG4gICAgICAgICAgICAgIGNhc2UgJ3NldCc6XG4gICAgICAgICAgICAgICAgdGhpcy5jb3VudFtrZXldID0gdmFsO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICBjYXNlICdhZGQnOlxuICAgICAgICAgICAgICAgIHRoaXMuY291bnRba2V5XSArPSB2YWw7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIGNhc2UgJ3N1YnRyYWN0JzpcbiAgICAgICAgICAgICAgICB0aGlzLmNvdW50W2tleV0gLT0gdmFsO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIGFyZ3VtZW50cyBzdXBwbGllZCAoaW52YWxpZCBvcGVyYXRpb24pLicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF0aGlzLnNldHRpbmdzLmFsbG93TmVnYXRpdmUpIHtcbiAgICAgICAgICAgICAgdGhpcy5jb3VudFtrZXldID0gTWF0aC5tYXgodGhpcy5jb3VudFtrZXldLCAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgYXJndW1lbnRzIHN1cHBsaWVkIChjb3VudCB2YWx1ZSBpcyBub3QgYW4gaW50ZWdlcikuJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIGFyZ3VtZW50cyBzdXBwbGllZCAod3JvbmcgcHJvcGVydHkpLicpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5fYWRqdXN0SW5mbyA9IGZ1bmN0aW9uKG9wZXJhdGlvbiwgaW5mbykge1xuICAgICAgaWYgKHRoaXMuX3R5cGUoaW5mbykgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGlmICgoaW5mby5lbGFwc2VkICE9IG51bGwpICYmIChpbmZvLmNsb2NrICE9IG51bGwpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgYXJndW1lbnRzIHN1cHBsaWVkIChib3RoIGVsYXBzZWQgYW5kIGNsb2NrIHRpbWVzKS4nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaW5mby5lbGFwc2VkICE9IG51bGwpIHtcbiAgICAgICAgICB0aGlzLl9hZGp1c3RSdW5UaW1lKG9wZXJhdGlvbiwgdGhpcy5fZWxhcHNlZFRpbWVUb1J1blRpbWUoaW5mby5lbGFwc2VkKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGluZm8uY2xvY2sgIT0gbnVsbCkge1xuICAgICAgICAgIHRoaXMuX2FkanVzdFJ1blRpbWUob3BlcmF0aW9uLCB0aGlzLl9jbG9ja1RpbWVUb1J1blRpbWUoaW5mby5jbG9jaykpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpbmZvLmNvdW50ICE9IG51bGwpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5fYWRqdXN0Q291bnQob3BlcmF0aW9uLCBpbmZvLmNvdW50KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgYXJndW1lbnRzIHN1cHBsaWVkICh3cm9uZyB0eXBlKS4nKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgTG9ja3N0ZXAucHJvdG90eXBlLl9sb29wID0gZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnB1bHNlID0gcmFmKHRoaXMuX2xvb3ApO1xuICAgICAgcmV0dXJuIHRoaXMuX3N0ZXAoKTtcbiAgICB9O1xuXG4gICAgTG9ja3N0ZXAucHJvdG90eXBlLl9zdGVwID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5zZXR0aW5ncy5zdGVwKHRoaXMuX2dldEluZm8oKSk7XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgICBpZiAoY2FsbGJhY2sgPT0gbnVsbCkge1xuICAgICAgICBjYWxsYmFjayA9IHRoaXMuc2V0dGluZ3Muc3RhcnQ7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMucnVubmluZykge1xuICAgICAgICB0aGlzLmNvdW50LnN0YXJ0Kys7XG4gICAgICAgIHRoaXMucnVubmluZyA9IHRydWU7XG4gICAgICAgIHRoaXMudGltZS5zdGFydCA9IG5vdygpO1xuICAgICAgICB0aGlzLl9sb29wKCk7XG4gICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIGNhbGxiYWNrKHRoaXMuX2dldEluZm8oKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICBMb2Nrc3RlcC5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgICBpZiAoY2FsbGJhY2sgPT0gbnVsbCkge1xuICAgICAgICBjYWxsYmFjayA9IHRoaXMuc2V0dGluZ3Muc3RvcDtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgICAgcmFmLmNhbmNlbCh0aGlzLnB1bHNlKTtcbiAgICAgICAgdGhpcy50aW1lLnN0b3AgPSBub3coKTtcbiAgICAgICAgdGhpcy50aW1lLnJ1biArPSB0aGlzLnRpbWUuc3RvcCAtIHRoaXMudGltZS5zdGFydDtcbiAgICAgICAgdGhpcy5jb3VudC5zdG9wKys7XG4gICAgICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9zdGVwKCk7XG4gICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIGNhbGxiYWNrKHRoaXMuX2dldEluZm8oKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICBMb2Nrc3RlcC5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbihjYWxsYmFjaywgY291bnQpIHtcbiAgICAgIHZhciBjYWxsYmFja0VsaWdpYmxlLCBrZXksIHZhbCwgX3JlZjtcbiAgICAgIGlmIChjYWxsYmFjayA9PSBudWxsKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdGhpcy5zZXR0aW5ncy5yZXNldDtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnRpbWUucnVuID4gMCkge1xuICAgICAgICBjYWxsYmFja0VsaWdpYmxlID0gdHJ1ZTtcbiAgICAgICAgdGhpcy50aW1lLnJ1biA9IDA7XG4gICAgICAgIHRoaXMuY291bnQucmVzZXQrKztcbiAgICAgICAgdGhpcy50aW1lLnN0YXJ0ID0gbm93KCk7XG4gICAgICAgIHRoaXMudGltZS5zdG9wID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIGlmIChjb3VudCkge1xuICAgICAgICBfcmVmID0gdGhpcy5jb3VudDtcbiAgICAgICAgZm9yIChrZXkgaW4gX3JlZikge1xuICAgICAgICAgIHZhbCA9IF9yZWZba2V5XTtcbiAgICAgICAgICBpZiAodmFsID4gMCkge1xuICAgICAgICAgICAgY2FsbGJhY2tFbGlnaWJsZSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmNvdW50LnN0YXJ0ID0gMDtcbiAgICAgICAgICAgIHRoaXMuY291bnQuc3RvcCA9IDA7XG4gICAgICAgICAgICB0aGlzLmNvdW50LnJlc2V0ID0gMDtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKChjYWxsYmFjayAhPSBudWxsKSAmJiBjYWxsYmFja0VsaWdpYmxlKSB7XG4gICAgICAgIGlmICh0aGlzLl90eXBlKGNhbGxiYWNrKSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgY2FsbGJhY2sodGhpcy5fZ2V0SW5mbygpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgYXJndW1lbnRzIHN1cHBsaWVkICh3cm9uZyB0eXBlKS4nKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24oaW5mbywgY2FsbGJhY2spIHtcbiAgICAgIGlmIChjYWxsYmFjayA9PSBudWxsKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdGhpcy5zZXR0aW5ncy5pbmZvO1xuICAgICAgfVxuICAgICAgaWYgKGluZm8gIT0gbnVsbCkge1xuICAgICAgICB0aGlzLl9hZGp1c3RJbmZvKCdzZXQnLCBpbmZvKTtcbiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgY2FsbGJhY2sodGhpcy5fZ2V0SW5mbygpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRJbmZvKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIExvY2tzdGVwLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbihpbmZvLCBjYWxsYmFjaykge1xuICAgICAgaWYgKGNhbGxiYWNrID09IG51bGwpIHtcbiAgICAgICAgY2FsbGJhY2sgPSB0aGlzLnNldHRpbmdzLmFkZDtcbiAgICAgIH1cbiAgICAgIGlmIChpbmZvICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5fYWRqdXN0SW5mbygnYWRkJywgaW5mbyk7XG4gICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIGNhbGxiYWNrKHRoaXMuX2dldEluZm8oKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGFyZ3VtZW50cyBzdXBwbGllZC4nKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgTG9ja3N0ZXAucHJvdG90eXBlLnN1YnRyYWN0ID0gZnVuY3Rpb24oaW5mbywgY2FsbGJhY2spIHtcbiAgICAgIGlmIChjYWxsYmFjayA9PSBudWxsKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdGhpcy5zZXR0aW5ncy5zdWJ0cmFjdDtcbiAgICAgIH1cbiAgICAgIGlmIChpbmZvICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5fYWRqdXN0SW5mbygnc3VidHJhY3QnLCBpbmZvKTtcbiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgY2FsbGJhY2sodGhpcy5fZ2V0SW5mbygpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gYXJndW1lbnRzIHN1cHBsaWVkLicpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4gTG9ja3N0ZXA7XG5cbiAgfSkoKTtcblxuICBtb2R1bGUuZXhwb3J0cyA9IExvY2tzdGVwO1xuXG59KS5jYWxsKHRoaXMpO1xuXG59KS5jYWxsKHRoaXMscmVxdWlyZShcIjFZaVo1U1wiKSkiXX0=
(5)
});
